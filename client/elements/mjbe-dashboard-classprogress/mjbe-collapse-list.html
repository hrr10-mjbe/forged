<dom-module id="mjbe-collapse-list">
  <template>
    <style>
    :host {
      @apply(--layout-fit);
      @apply(--layout-vertical);
      @apply(--paper-font-common-base);
      background-color: var(--paper-grey-200, #eee);
    }
    
    paper-toolbar {
      background: var(--google-green-700);
      box-shadow: 0 2px 5px 0 rgba(0, 0, 0, 0.3);
      font-weight: bold;
      z-index: 1;
      --paper-toolbar-title: {
        overflow: visible;
      }
      ;
    }
    
    paper-toolbar paper-icon-button {
      --paper-icon-button-ink-color: white;
    }
    
    iron-list {
      padding-top: 1px;
      padding-bottom: 16px;
      padding-left: 20px;
      padding-right: 120px;
      -webkit-flex: 1 1;
      flex: 1 1;
      --iron-list-items-container: {
        max-width: 800px;
        margin: auto;
        margin-top: 60px;
        margin-bottom: 60px;
        border-bottom: 1px solid #ddd;
      }
      ;
    }
    
    .item {
      @apply(--layout-horizontal);
      padding: 20px;
      background-color: white;
      border: 1px solid #ddd;
      margin-bottom: 10px;
    }
    
    .item:focus {
      outline: 0;
      border-color: #666;
    }
    
    .avatar {
      height: 40px;
      width: 40px;
      border-radius: 20px;
      box-sizing: border-box;
      background-color: #DDD;
    }
    
    .pad {
      padding: 0 16px;
      @apply(--layout-flex);
      @apply(--layout-vertical);
    }
    
    .primary {
      font-size: 16px;
      font-weight: bold;
    }
    
    .shortText,
    .longText {
      font-size: 14px;
    }
    
    .longText {
      color: gray;
      display: none;
    }

    .item:hover {
      background-color: #F7F7F7;
    }
    
/*    .item:hover .shortText::after {
      content: ' [+]';
      color: gray;
    }
    
    .item.expanded:hover .shortText::after {
      content: '';
    }
    
    .item.expanded .longText {
      display: block;
    }
    
    .item.expanded:hover .longText::after {
      content: ' [â€“]';
    }*/
    
    .spacer {
      @apply(--layout-flex);
    }
    
    @media (max-width: 460px) {
      paper-toolbar .bottom.title {
        font-size: 14px;
      }
    }
    .modText {
      font-size: 12px;
    }
    paper-checkbox.mod {
      --paper-checkbox-checked-color: #4CD964;
      --paper-checkbox-checked-ink-color: #4CD964;
      color: red;
    }
    </style>

    <paper-toolbar>
      <div>
        <paper-icon-button icon="add" alt="Add student" on-tap="inviteModal"></paper-icon-button>
      </div>
      <div>
        <template is="dom-if" if="{{!modsOpened}}">
          <paper-tab on-tap="toggleEdit" style="margin-left: 75px;">Edit</paper-tab>
        </template>
        <template is="dom-if" if="{{modsOpened}}">
          <paper-tab on-tap="toggleEdit" style="margin-left: 75px;">Cancel</paper-tab>
          <paper-tab style="margin-left: 75px;">Save</paper-tab>
        </template>
      </div>
    </paper-toolbar>

    <iron-list id="list" items="[[items]]" as="item">
      <template>
        <div class$="[[getClassForItem(item, item.expanded)]]" tabindex="0">
          <div class="horizontal justified layout flex">
            <div class="horizontal layout">
              <div class="self-center">
                <iron-icon icon="face"></iron-icon>
              </div>
              <div class="pad self-center">
                <div class="primary">[[item.name]] [[item.pending]]
                  <template is="dom-if" if="{{isPending(item)}}">
                    (Invitation pending)
                  </template>
                </div>
                <div class="shortText">[[item.email]]</div>
                <div class="longText">Skills: [[item.studentData.skills.length]]</div>
              </div>
            </div>
            <div class="self-center">
              <template is="dom-if" if="{{modsOpened}}">
                <span class="modText">Timer: </span><paper-checkbox class="mod"></paper-checkbox>
                <span class="modText">Leaderboard: </span><paper-checkbox class="mod"></paper-checkbox>
                <span class="modText">Whiteboard: </span><paper-checkbox class="mod"></paper-checkbox>
              </template>
            </div>
          </div>
        </div>
      </template>
      <!-- <template>
        <div on-tap="_collapseExpand">
          <div class$="[[getClassForItem(item, item.expanded)]]" tabindex="0">
            <iron-icon icon="accessibility"></iron-icon>
            <div class="pad">
              <div class="primary">[[item.name]] [[item.pending]]
                <template is="dom-if" if="{{isPending(item)}}">
                  (Invitation pending)
                </template>
              </div>
              <div class="shortText">[[item.email]]</div>
              <div class="longText">Skills: [[item.studentData.skills.length]]</div>
            </div>
          </div>
        </div>
      </template> -->

    </iron-list>

    <!--modal to invite new students-->
    <paper-dialog id="inviteDialog" modal entry-animation="scale-up-animation" exit-animation="fade-out-animation">
      <paper-input label="Student email" value="{{email::input}}" type="text" autofocus></paper-input>
      <paper-button raised dialog-confirm on-tap="invite">Invite</paper-button>
      <paper-button dialog-confirm autofocus>Cancel</paper-button>
    </paper-dialog>
  </template>
  <script>
  HTMLImports.whenReady(function() {
    Polymer({
      is: 'mjbe-collapse-list',
      properties: {
        //list of students
        items: {
          type: Array,
          computed: 'parseData(data)'
        },

        /*name: {
          type: String,
          notify: true
        },*/

        //raw stringified student data pulled from the dom
        data: {
          type: String,
          notify: true
        },

        //email of student to invite
        email: {
          notify: true
        },

        //count of number of invitations (see explanation in mjbe-dashboard)
        invitecount: {
          notify: true
        },

        //class currently being viewed
        activeclass: {
          notify: true
        },

        modsOpened: {
          notify: true,
          value: false
        }
      },

      toggleEdit: function() {
        this.modsOpened = !this.modsOpened;
      },

      _collapseExpand: function(e) {
        var list = this.$.list;
        var index = e.model.index;
        var isExpanded = list.items[index].expanded;
        list.set('items.' + index + '.expanded', !isExpanded);
        list.updateSizeForItem(e.model.index);
      },

      getClassForItem: function(item, expanded) {
        return expanded ? 'item expanded' : 'item';
      },

      //converts raw string into real data and sets it up for the collapse list
      parseData: function(data) {
        console.log('---inside parseData---')
        console.log('string data (from Angular?):')
        console.log(data)
        try {
        var result = JSON.parse(data);
        for (var i = 0; i < result.length; i++) {
          result[i].expanded = false;
        }
        console.log('---parsed data---')
        console.log(result)
        return result;
      } catch (e) {}
      },

      //opens the invite dialog
      inviteModal: function() {
        this.$.inviteDialog.open();
      },

      //sends invite by incrementing invitecount and triggering Angular
      invite: function() {
        this.invitecount = '' + (Number.parseInt(this.invitecount) + 1);
      },

      //check whether current student is pending or actual
      isPending: function(item) {
        return item.status === 'pending';
      }
    });
  });
  </script>
</dom-module>
